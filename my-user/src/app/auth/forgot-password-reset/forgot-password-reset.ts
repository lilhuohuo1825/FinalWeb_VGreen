import { Component, OnInit } from '@angular/core';
import { FormsModule } from '@angular/forms';
import { CommonModule } from '@angular/common';
import { Router, RouterModule } from '@angular/router';
import { HttpClient } from '@angular/common/http';

@Component({
  selector: 'app-forgot-password-reset',
  standalone: true,
  imports: [FormsModule, CommonModule, RouterModule],
  templateUrl: './forgot-password-reset.html',
  styleUrls: ['./forgot-password-reset.css'],
})
export class ForgotPasswordReset implements OnInit {
  phoneNumber: string = '';
  password: string = '';
  confirmPassword: string = '';

  passwordError: string = '';
  confirmError: string = '';

  showPassword: boolean = false;
  showConfirm: boolean = false;

  showSuccessMessage: boolean = false;
  isSubmitting: boolean = false; // TH√äM FLAG N√ÄY
  resetSuccessful: boolean = false; // TH√äM FLAG N√ÄY

  constructor(private router: Router, private http: HttpClient) {}

  ngOnInit(): void {
    // console.log('üîç ForgotPasswordReset ngOnInit called');
    // console.log('üîç resetSuccessful flag:', this.resetSuccessful);
    // console.log('üîç Current URL:', window.location.href);

    // Ki·ªÉm tra flag t·ª´ sessionStorage
    const resetCompleted = sessionStorage.getItem('passwordResetCompleted');
    // console.log('üîç passwordResetCompleted from sessionStorage:', resetCompleted);

    // N·∫øu ƒë√£ ho√†n th√†nh reset, redirect v·ªÅ login
    if (resetCompleted === 'true') {
      // console.log('‚è≠Ô∏è Password reset completed, redirecting to login');
      sessionStorage.removeItem('passwordResetCompleted');
      this.router.navigate(['/login']); // d√πng Angular Router
      return;
    }

    // N·∫øu ƒëang trong qu√° tr√¨nh reset th√†nh c√¥ng, kh√¥ng l√†m g√¨ c·∫£
    if (this.resetSuccessful) {
      console.log('>>> Reset th√†nh c√¥ngc√¥ng');
      return;
    }

    // Get phone number from session storage
    this.phoneNumber = sessionStorage.getItem('forgotPasswordPhone') || '';
    const otpVerified = sessionStorage.getItem('forgotPasswordOtpVerified');

    // console.log('üîç ForgotPasswordReset ngOnInit:');
    console.log('Phone:', this.phoneNumber);
    console.log('OTP Verified:', otpVerified);

    // Ki·ªÉm tra ƒëi·ªÅu ki·ªán truy c·∫≠p trang
    if (!this.phoneNumber || !otpVerified) {
      console.log('(x) Missing phone or OTP verification, redirecting to forgot-password');
      console.log('(x) Phone missing:', !this.phoneNumber);
      console.log('(x) OTP not verified:', !otpVerified);

      // Ch·ªâ redirect n·∫øu ch∆∞a reset th√†nh c√¥ng
      if (!this.resetSuccessful) {
        // console.log('üîÑ Redirecting to /forgot-password');
        this.router.navigate(['/forgot-password']);
      }
      // else {
      //   console.log('‚è≠Ô∏è Reset successful, not redirecting');
      // }
      return;
    }

    // console.log('‚úÖ Ready for password reset form');
  }

  onPasswordInput(event: any): void {
    const value = event.target.value;
    this.password = value;
    this.passwordError = '';
    this.validatePassword();
    this.validateConfirm(); // Re-validate confirm password when password changes
  }

  onConfirmInput(event: any): void {
    const value = event.target.value;
    this.confirmPassword = value;
    this.confirmError = '';
    this.validateConfirm();
  }

  togglePassword(): void {
    this.showPassword = !this.showPassword;
  }

  toggleConfirm(): void {
    this.showConfirm = !this.showConfirm;
  }

  validatePassword(): void {
    this.passwordError = '';

    if (this.password.length < 8) {
      this.passwordError = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±.';
      return;
    }

    if (!/[A-Z]/.test(this.password)) {
      this.passwordError = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ c√°i in hoa.';
      return;
    }

    if (!/[a-z]/.test(this.password)) {
      this.passwordError = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ c√°i th∆∞·ªùng.';
      return;
    }
  }

  validateConfirm(): void {
    if (this.confirmPassword && this.password !== this.confirmPassword) {
      this.confirmError = 'M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp.';
    } else {
      this.confirmError = '';
    }
  }

  isFormValid(): boolean {
    const hasMinLength = this.password.length >= 8;
    const hasUppercase = /[A-Z]/.test(this.password);
    const hasLowercase = /[a-z]/.test(this.password);
    const passwordsMatch = this.password === this.confirmPassword;
    const noPasswordError = !this.passwordError;
    const noConfirmError = !this.confirmError;

    const isValid =
      hasMinLength &&
      hasUppercase &&
      hasLowercase &&
      passwordsMatch &&
      noPasswordError &&
      noConfirmError;

    // console.log('üîç Form validation check:');
    // console.log('üìù Password length >= 8:', hasMinLength);
    // console.log('üìù Has uppercase:', hasUppercase);
    // console.log('üìù Has lowercase:', hasLowercase);
    // console.log('üìù Passwords match:', passwordsMatch);
    // console.log('üìù No password error:', noPasswordError);
    // console.log('üìù No confirm error:', noConfirmError);
    // console.log('üìù Form valid:', isValid);

    return isValid;
  }

  onSubmit(event?: Event): void {
    // NgƒÉn ch·∫∑n default form submission ƒë·ªÉ tr√°nh page reload
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }

    // console.log('üîÑ onSubmit() called - Using reset password logic');

    // S·ª≠ d·ª•ng logic reset password ƒë∆°n gi·∫£n
    this.resetPassword();
  }

  // Reset password method
  resetPassword(): void {
    // console.log('üîÑ RESET PASSWORD CALLED');

    if (!this.isFormValid()) {
      console.warn('‚ùå Form kh√¥ng h·ª£p l·ªá, kh√¥ng g·ª≠i y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u.');
      return;
    }

    const payload = {
      phoneNumber: this.phoneNumber,
      newPassword: this.password,
    };

    this.isSubmitting = true;

    this.http.post('/api/auth/reset-password', payload).subscribe({
      next: (response: any) => {
        console.log('>>>M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng:', response);
        this.showSuccessMessage = true;
        this.resetSuccessful = true;

        // X√≥a sessionStorage ƒë·ªÉ tr√°nh l·ªói redirect l·∫°i
        sessionStorage.removeItem('forgotPasswordPhone');
        sessionStorage.removeItem('forgotPasswordOtpVerified');
        sessionStorage.setItem('passwordResetCompleted', 'true');

        setTimeout(() => {
          this.isSubmitting = false;
          window.location.href = '/login';
        }, 800);
      },
      error: (error) => {
        console.error('(x) L·ªói khi c·∫≠p nh·∫≠t m·∫≠t kh·∫©u:', error);
        this.isSubmitting = false;
      },
    });
  }

  // Navigate to login page
  navigateToLogin(): void {
    // console.log('üîÑ Navigate to login clicked');
    this.router.navigate(['/login']);
  }
}
