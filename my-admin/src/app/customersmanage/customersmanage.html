<!-- Customers Management Page -->
<div class="customers-page" (click)="closeDropdowns($event)">
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <span>Qu·∫£n tr·ªã vi√™n</span>
    <span class="separator">/</span>
    <span>Qu·∫£n l√Ω kh√°ch h√†ng</span>
    <span class="separator">/</span>
    <span class="current">Danh s√°ch kh√°ch h√†ng</span>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">DANH S√ÅCH KH√ÅCH H√ÄNG</h1>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <!-- Search Container (Left aligned) -->
    <div class="search-container">
      <input type="text" class="search-input" placeholder="T√¨m ki·∫øm kh√°ch h√†ng..." (input)="searchCustomers($event)">
      <button class="search-btn">
        <img src="asset/icons/search_dark.png" alt="Search">
      </button>
    </div>

    <!-- Actions (Right aligned) -->
    <div class="actions-container">
      <span class="selected-count">{{selectedCount}} ƒë√£ ch·ªçn</span>
      <button class="btn-action btn-edit" (click)="editCustomers()" [disabled]="selectedCount === 0">
        <img src="asset/icons/edit_dark.png" alt="Edit">
        <span>Ch·ªânh</span>
      </button>
      <button class="btn-action btn-group" (click)="manageGroups()" [disabled]="selectedCount < 2">
        <img src="asset/icons/customer_dark.png" alt="Group">
        <span>Nh√≥m</span>
      </button>
      <button 
        class="btn-action btn-delete" 
        [class.disabled]="selectedCount === 0"
        [disabled]="selectedCount === 0"
        (click)="deleteCustomers(); $event.stopPropagation(); $event.preventDefault()" 
        type="button">
        <img src="asset/icons/trash_red.png" alt="Delete">
        <span>Xo√°</span>
      </button>
      <!-- Filter Dropdown -->
      <div class="dropdown-container">
        <button class="btn-action btn-filter" [class.active]="showFilterDropdown" (click)="toggleFilterDropdown($event)">
          <img src="asset/icons/filter_dark.png" alt="Filter">
          <span>L·ªçc {{showFilterDropdown ? '‚úì' : ''}}</span>
          <span class="dropdown-arrow">‚ñº</span>
        </button>
        <div class="dropdown-menu dropdown-menu-multilevel" *ngIf="showFilterDropdown" (click)="$event.stopPropagation()">
          <!-- Member Tier with Submenu -->
          <div class="dropdown-item-parent">
            <div class="dropdown-item">
              <img src="asset/icons/customer_dark.png" alt="Member Tier" class="item-icon">
              <span>H·∫°ng th√†nh vi√™n</span>
              <span class="arrow-right">‚Ä∫</span>
            </div>
            <div class="dropdown-submenu">
              <label class="dropdown-option" (click)="toggleMemberTierFilter('all')">
                <input type="checkbox" [checked]="filterOptions.memberTier === 'all'" (click)="$event.stopPropagation()">
                <span>üìä T·∫•t c·∫£</span>
              </label>
              <label class="dropdown-option" (click)="toggleMemberTierFilter('gold')">
                <input type="checkbox" [checked]="filterOptions.memberTier === 'gold'" (click)="$event.stopPropagation()">
                <span>‚≠ê V√†ng (VIP)</span>
              </label>
              <label class="dropdown-option" (click)="toggleMemberTierFilter('silver')">
                <input type="checkbox" [checked]="filterOptions.memberTier === 'silver'" (click)="$event.stopPropagation()">
                <span>ü•à B·∫°c (Premium)</span>
              </label>
              <label class="dropdown-option" (click)="toggleMemberTierFilter('bronze')">
                <input type="checkbox" [checked]="filterOptions.memberTier === 'bronze'" (click)="$event.stopPropagation()">
                <span>ü•â ƒê·ªìng (Regular)</span>
              </label>
            </div>
          </div>
          
          <!-- Group with Submenu -->
          <div class="dropdown-item-parent">
            <div class="dropdown-item">
              <img src="asset/icons/group.png" alt="Group" class="item-icon">
              <span>Nh√≥m kh√°ch h√†ng</span>
              <span class="arrow-right">‚Ä∫</span>
            </div>
            <div class="dropdown-submenu dropdown-submenu-scrollable" *ngIf="allGroupNames.length > 0">
              <label class="dropdown-option" (click)="toggleGroupFilterDropdown('all')">
                <input type="checkbox" [checked]="filterOptions.group === 'all'" (click)="$event.stopPropagation()">
                <span>üìä T·∫•t c·∫£</span>
              </label>
              <label class="dropdown-option" *ngFor="let groupName of allGroupNames" (click)="toggleGroupFilterDropdown(groupName)">
                <input type="checkbox" [checked]="filterOptions.group === groupName" (click)="$event.stopPropagation()">
                <span>{{groupName}}</span>
              </label>
            </div>
            <div class="dropdown-submenu" *ngIf="allGroupNames.length === 0">
              <div class="dropdown-empty">
                <img src="asset/icons/group.png" alt="Group" class="empty-icon" style="width: 20px; height: 20px;">
                <span>Ch∆∞a c√≥ nh√≥m n√†o</span>
              </div>
            </div>
          </div>
          
          <div class="dropdown-divider"></div>
          <div class="dropdown-actions">
            <button class="btn-clear-filter" (click)="clearAllFilters()">
              <img src="asset/icons/trash_red.png" alt="Clear Filter" style="width: 16px; height: 16px;">
              <span>X√≥a b·ªô l·ªçc</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Sort Dropdown -->
      <div class="dropdown-container">
        <button class="btn-action btn-sort" [class.active]="showSortDropdown" (click)="toggleSortDropdown($event)">
          <span class="icon-sort">‚áÖ</span>
          <span>S·∫Øp x·∫øp {{showSortDropdown ? '‚úì' : ''}}</span>
          <span class="dropdown-arrow">‚ñº</span>
        </button>
        <div class="dropdown-menu dropdown-menu-sort" *ngIf="showSortDropdown" (click)="$event.stopPropagation()">
          <!-- Sort by Name -->
          <div class="sort-option" 
               [class.active]="currentSortField === 'name'" 
               (click)="sortBy('name')">
            <div class="sort-option-icon">
              <img src="asset/icons/name.png" alt="Name" style="width: 24px; height: 24px;">
            </div>
            <div class="sort-option-content">
              <div class="sort-option-label">T√™n kh√°ch h√†ng</div>
              <div class="sort-option-desc">A ‚Üí Z ho·∫∑c Z ‚Üí A</div>
            </div>
            <div class="sort-option-indicator" *ngIf="currentSortField === 'name'">
              <div class="indicator-badge" [class.asc]="currentSortOrder === 'asc'" [class.desc]="currentSortOrder === 'desc'">
                {{currentSortOrder === 'asc' ? 'A‚ÜíZ' : 'Z‚ÜíA'}}
              </div>
            </div>
          </div>

          <!-- Sort by Join Date -->
          <div class="sort-option" 
               [class.active]="currentSortField === 'joinDate'" 
               (click)="sortBy('joinDate')">
            <div class="sort-option-icon">
              <img src="asset/icons/calendar.png" alt="Calendar" style="width: 24px; height: 24px;">
            </div>
            <div class="sort-option-content">
              <div class="sort-option-label">Ng√†y tham gia</div>
              <div class="sort-option-desc">C≈© ƒë·∫øn m·ªõi / M·ªõi ƒë·∫øn c≈©</div>
            </div>
            <div class="sort-option-indicator" *ngIf="currentSortField === 'joinDate'">
              <div class="indicator-badge" [class.asc]="currentSortOrder === 'asc'" [class.desc]="currentSortOrder === 'desc'">
                {{currentSortOrder === 'asc' ? '‚Üë' : '‚Üì'}}
              </div>
            </div>
          </div>

          <!-- Sort by Total Spending -->
          <div class="sort-option" 
               [class.active]="currentSortField === 'totalOrders'" 
               (click)="sortBy('totalOrders')">
            <div class="sort-option-icon">
              <img src="asset/icons/price.png" alt="Price" style="width: 24px; height: 24px;">
            </div>
            <div class="sort-option-content">
              <div class="sort-option-label">T·ªïng chi ti√™u</div>
              <div class="sort-option-desc">Th·∫•p ƒë·∫øn cao / Cao ƒë·∫øn th·∫•p</div>
            </div>
            <div class="sort-option-indicator" *ngIf="currentSortField === 'totalOrders'">
              <div class="indicator-badge" [class.asc]="currentSortOrder === 'asc'" [class.desc]="currentSortOrder === 'desc'">
                {{currentSortOrder === 'asc' ? '‚Üë' : '‚Üì'}}
              </div>
            </div>
          </div>

          <!-- Sort by Member Tier -->
          <div class="sort-option" 
               [class.active]="currentSortField === 'memberTier'" 
               (click)="sortBy('memberTier')">
            <div class="sort-option-icon">
              <img src="asset/icons/star_dark.png" alt="Rating" style="width: 24px; height: 24px;">
            </div>
            <div class="sort-option-content">
              <div class="sort-option-label">H·∫°ng th√†nh vi√™n</div>
              <div class="sort-option-desc">Cao ƒë·∫øn th·∫•p / Th·∫•p ƒë·∫øn cao</div>
            </div>
            <div class="sort-option-indicator" *ngIf="currentSortField === 'memberTier'">
              <div class="indicator-badge" [class.asc]="currentSortOrder === 'asc'" [class.desc]="currentSortOrder === 'desc'">
                {{currentSortOrder === 'asc' ? '‚Üë' : '‚Üì'}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Customers Table -->
  <div class="customers-table-container">
    <table class="customers-table">
      <thead>
        <tr>
          <th class="col-checkbox">
            <input type="checkbox" class="checkbox-all" [checked]="selectAll" (change)="toggleSelectAll()">
          </th>
          <th class="col-customer-id">M√£ kh√°ch h√†ng</th>
          <th class="col-join-date">Th·ªùi gian tham gia</th>
          <th class="col-name">Kh√°ch h√†ng</th>
          <th class="col-address">ƒê·ªãa ch·ªâ</th>
          <th class="col-tier">H·∫°ng th√†nh vi√™n</th>
          <th class="col-total">T·ªïng ƒë∆°n</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamic Customer Rows -->
        <tr class="customer-row" *ngFor="let customer of customers" (click)="viewCustomerDetail(customer)">
          <td class="col-checkbox" (click)="$event.stopPropagation()">
            <input type="checkbox" class="checkbox-item" [checked]="customer.selected" (change)="toggleCustomer(customer)">
          </td>
          <td class="col-customer-id">{{customer.id}}</td>
          <td class="col-join-date">{{customer.joinDate}}</td>
          <td class="col-name">{{customer.name}}</td>
          <td class="col-address">{{customer.address}}</td>
          <td class="col-tier">
            <span class="tier-badge" [ngClass]="getMemberTierClass(customer.memberTier)">
              {{getMemberTierLabel(customer.memberTier)}}
            </span>
          </td>
          <td class="col-total">{{customer.totalOrders}}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Batch Edit Modal -->
<div class="group-modal-overlay" *ngIf="showBatchEditModal" (click)="closeBatchEditModal()">
  <div class="group-modal-content" (click)="$event.stopPropagation()">
    <div class="group-modal-header">
      <h3 class="group-modal-title">
        <img src="asset/icons/edit_dark.png" alt="Edit" class="title-icon" style="width: 20px; height: 20px;">
        Ch·ªânh s·ª≠a h√†ng lo·∫°t
      </h3>
      <button class="btn-close-modal" (click)="closeBatchEditModal()">√ó</button>
    </div>

    <div class="group-modal-body">
      <p class="group-modal-desc">
        ƒêang ch·ªânh s·ª≠a <strong>{{selectedCount}}</strong> kh√°ch h√†ng ƒë√£ ch·ªçn
      </p>

      <div class="group-form-group">
        <label class="group-label">Ch·ªçn thao t√°c:</label>
        <select class="group-name-input" [(ngModel)]="batchEditOption">
          <option value="">-- Ch·ªçn thao t√°c --</option>
          <option value="tier">Thay ƒë·ªïi h·∫°ng th√†nh vi√™n</option>
          <option value="group">Thay ƒë·ªïi nh√≥m</option>
          <option value="removeGroup">X√≥a kh·ªèi nh√≥m</option>
        </select>
      </div>

      <!-- Tier Selection -->
      <div class="group-form-group" *ngIf="batchEditOption === 'tier'">
        <label class="group-label">Ch·ªçn h·∫°ng m·ªõi:</label>
        <select class="group-name-input" [(ngModel)]="selectedTier">
          <option value="">-- Ch·ªçn h·∫°ng --</option>
          <option value="gold">V√†ng (VIP)</option>
          <option value="silver">B·∫°c (Premium)</option>
          <option value="bronze">ƒê·ªìng (Regular)</option>
        </select>
      </div>

      <!-- Group Selection -->
      <div class="group-form-group" *ngIf="batchEditOption === 'group'">
        <label class="group-label">T√™n nh√≥m:</label>
        <input 
          type="text" 
          class="group-name-input" 
          placeholder="VD: Kh√°ch h√†ng VIP, Kh√°ch h√†ng th√¢n thi·∫øt..." 
          [(ngModel)]="selectedGroupForBatch">
      </div>

      <div class="group-info" *ngIf="batchEditOption">
        <img src="asset/icons/info_dark.png" alt="Info" class="info-icon" style="width: 16px; height: 16px;">
        <span>Thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng cho t·∫•t c·∫£ kh√°ch h√†ng ƒë√£ ch·ªçn</span>
      </div>
    </div>

    <div class="group-modal-footer">
      <button class="btn-cancel-group" (click)="closeBatchEditModal()">H·ªßy</button>
      <button class="btn-create-group" (click)="applyBatchEdit()" [disabled]="!batchEditOption">
        <span>‚úì</span> √Åp d·ª•ng
      </button>
    </div>
  </div>
</div>

<!-- Group Modal -->
<div class="group-modal-overlay" *ngIf="showGroupModal" (click)="closeGroupModal()">
  <div class="group-modal-content" (click)="$event.stopPropagation()">
    <div class="group-modal-header">
      <h3 class="group-modal-title">
        <img src="asset/icons/group.png" alt="Group" class="title-icon" style="width: 20px; height: 20px;">
        T·∫°o nh√≥m kh√°ch h√†ng
      </h3>
      <button class="btn-close-modal" (click)="closeGroupModal()">√ó</button>
    </div>

    <div class="group-modal-body">
      <p class="group-modal-desc">
        B·∫°n ƒëang nh√≥m <strong>{{selectedCount}}</strong> kh√°ch h√†ng ƒë√£ ch·ªçn
      </p>

      <div class="group-form-group">
        <label class="group-label">T√™n nh√≥m:</label>
        <input 
          type="text" 
          class="group-name-input" 
          placeholder="VD: Kh√°ch h√†ng VIP, Kh√°ch h√†ng th√¢n thi·∫øt, Kh√°ch h√†ng m·ªõi..." 
          [(ngModel)]="newGroupName"
          (keyup.enter)="createGroup()"
          autofocus>
      </div>

      <div class="group-info">
        <img src="asset/icons/info_dark.png" alt="Info" class="info-icon" style="width: 16px; height: 16px;">
        <span>M·ªói kh√°ch h√†ng c√≥ th·ªÉ thu·ªôc nhi·ªÅu nh√≥m kh√°c nhau</span>
      </div>
    </div>

    <div class="group-modal-footer">
      <button class="btn-cancel-group" (click)="closeGroupModal()">H·ªßy</button>
      <button class="btn-create-group" (click)="createGroup()">
        <span>‚úì</span> T·∫°o nh√≥m
      </button>
    </div>
  </div>
</div>

<!-- Popup Notification -->
<div class="popup-overlay" *ngIf="showPopup" (click)="closePopup()">
  <div class="popup-container" (click)="$event.stopPropagation()">
    <div class="popup-content" [ngClass]="'popup-' + popupType">
      <div class="popup-icon">
        <span *ngIf="popupType === 'success'">‚úì</span>
        <span *ngIf="popupType === 'error'">‚úó</span>
        <span *ngIf="popupType === 'info'">‚Ñπ</span>
      </div>
      <div class="popup-message">{{popupMessage}}</div>
      <button class="popup-close" (click)="closePopup()">√ó</button>
    </div>
  </div>
</div>

<!-- Confirmation Dialog -->
<div class="popup-overlay" *ngIf="showConfirmDialog" (click)="cancelDelete()">
  <div class="confirm-dialog" (click)="$event.stopPropagation()">
    <div class="confirm-icon">
      <span class="icon-question">?</span>
    </div>
    <div class="confirm-message">{{ confirmMessage }}</div>
    <div class="confirm-buttons">
      <button class="btn-confirm-cancel" (click)="cancelDelete()">H·ªßy</button>
      <button class="btn-confirm-ok" (click)="confirmDelete()">OK</button>
    </div>
  </div>
</div>
