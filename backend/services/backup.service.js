const fs = require("fs");
const path = require("path");

class BackupService {
  constructor() {
    this.dataPath = path.join(__dirname, "../../data/users.json");
  }

  // ƒê·ªçc d·ªØ li·ªáu t·ª´ file JSON
  readUsers() {
    try {
      console.log("üìñ ƒêang ƒë·ªçc d·ªØ li·ªáu t·ª´ file JSON...");
      const data = fs.readFileSync(this.dataPath, "utf8");
      const users = JSON.parse(data);
      console.log(`‚úÖ ƒê√£ ƒë·ªçc ${users.length} users t·ª´ file JSON`);
      return users;
    } catch (error) {
      console.error("‚ùå L·ªói ƒë·ªçc file JSON:", error.message);
      return [];
    }
  }

  // Ghi d·ªØ li·ªáu v√†o file JSON
  writeUsers(users) {
    try {
      console.log("üíæ ƒêang ghi d·ªØ li·ªáu v√†o file JSON...");
      // S·ª≠ d·ª•ng replacer ƒë·ªÉ √©p phone th√†nh string
      const jsonString = JSON.stringify(
        users,
        (key, value) => {
          if (key === "phone") {
            return String(value); // √âp ki·ªÉu string
          }
          return value;
        },
        2
      );
      fs.writeFileSync(this.dataPath, jsonString);
      console.log("‚úÖ ƒê√£ ghi d·ªØ li·ªáu v√†o file JSON th√†nh c√¥ng!");
      return true;
    } catch (error) {
      console.error("‚ùå L·ªói ghi file JSON:", error.message);
      return false;
    }
  }

  // Th√™m user m·ªõi v√†o file JSON
  addUser(userData) {
    try {
      console.log("‚ûï ƒêang th√™m user m·ªõi v√†o file JSON...");
      const users = this.readUsers();

      // T·∫°o user m·ªõi theo c·∫•u tr√∫c file JSON
      const newUser = {
        _id: { $oid: this.generateObjectId() },
        user_id: users.length + 1,
        full_name: userData.FullName || "",
        phone: userData.Phone, // Gi·ªØ nguy√™n d·∫°ng string
        email: userData.Email || "",
        address: userData.Address || "",
        register_date: userData.RegisterDate
          ? userData.RegisterDate.toISOString().split("T")[0]
          : new Date().toISOString().split("T")[0],
        customer_type: userData.CustomerType || "Regular",
        password: userData.Password,
      };

      users.push(newUser);
      this.writeUsers(users);

      console.log("‚úÖ User ƒë√£ ƒë∆∞·ª£c th√™m v√†o file JSON:", {
        user_id: newUser.user_id,
        full_name: newUser.full_name,
        phone: newUser.phone, // Gi·ªØ nguy√™n d·∫°ng string
        register_date: newUser.register_date,
      });

      return newUser;
    } catch (error) {
      console.error("‚ùå L·ªói th√™m user v√†o file JSON:", error.message);
      return null;
    }
  }

  // C·∫≠p nh·∫≠t user trong file JSON
  updateUser(phone, updateData) {
    try {
      console.log("üîÑ ƒêang c·∫≠p nh·∫≠t user trong file JSON...");
      const users = this.readUsers();
      const userIndex = users.findIndex(
        (user) => user.phone === phone // So s√°nh string v·ªõi string
      );

      if (userIndex === -1) {
        console.log("‚ùå Kh√¥ng t√¨m th·∫•y user trong file JSON");
        return null;
      }

      // C·∫≠p nh·∫≠t th√¥ng tin
      if (updateData.Income !== undefined) {
        users[userIndex].income = updateData.Income;
      }
      if (updateData.Fee !== undefined) {
        users[userIndex].fee = updateData.Fee;
      }
      if (updateData.Password) {
        users[userIndex].password = updateData.Password;
      }
      if (updateData.PasswordVersion !== undefined) {
        users[userIndex].password_version = updateData.PasswordVersion;
      }
      if (updateData.LastPasswordReset) {
        users[userIndex].last_password_reset =
          updateData.LastPasswordReset.toISOString();
      }

      this.writeUsers(users);
      console.log("‚úÖ User ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong file JSON:", {
        user_id: users[userIndex].user_id,
        phone: users[userIndex].phone,
      });

      return users[userIndex];
    } catch (error) {
      console.error("‚ùå L·ªói c·∫≠p nh·∫≠t user trong file JSON:", error.message);
      return null;
    }
  }

  // T·∫°o ObjectId gi·∫£
  generateObjectId() {
    const timestamp = Math.floor(new Date().getTime() / 1000).toString(16);
    const random = Math.floor(Math.random() * 16777216).toString(16);
    return (
      timestamp + "0000000000000000".substring(0, 16 - random.length) + random
    );
  }
}

module.exports = new BackupService();
